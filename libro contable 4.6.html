<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema Contable Pro - Export Word</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .table-totals { background-color: #f1f3f5; font-weight: bold; }
        .btn-reset { background-color: #dc3545; color: white; border: none; }
        .btn-reset:hover { background-color: #a71d2a; }
        @media print { .no-print { display: none; } }
    </style>
</head>

<body class="bg-light">

<div class="container mt-4" id="contenido-contable">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h2>Sistema Contable Pro <span class="badge bg-dark">v3.0</span></h2>
        <div class="d-flex gap-2">
            <button onclick="guardarWord()" class="btn btn-outline-primary"> Guardar en Word</button>
            <button onclick="resetearPrograma()" class="btn btn-reset">锔 Resetear Programa</button>
        </div>
    </div>

    <div class="card p-3 mb-4 shadow-sm no-print">
        <div class="row">
            <div class="col-md-9">
                <div class="row mb-2">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Fecha</label>
                        <input type="date" id="fecha" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Cuenta</label>
                        <input type="text" id="cuenta" class="form-control" placeholder="Nombre de la cuenta">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Glosa</label>
                        <input type="text" id="glosa" class="form-control" placeholder="Descripci贸n">
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Debe</label>
                        <input type="number" id="debe" class="form-control" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Haber</label>
                        <input type="number" id="haber" class="form-control" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Tipo</label>
                        <select id="clasificacion" class="form-control">
                            <option value="Activo">Activo</option>
                            <option value="Pasivo">Pasivo</option>
                            <option value="Patrimonio">Patrimonio</option>
                            <option value="Ingreso">Ingreso</option>
                            <option value="Gasto">Gasto</option>
                            <option value="Costo">Costo</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button onclick="calcularIVA()" class="btn btn-info w-100 text-white fw-bold">Calcular IVA (19%)</button>
                    </div>
                </div>
            </div>

            <div class="col-md-3 d-grid gap-2">
                <button onclick="agregar()" class="btn btn-primary btn-lg">Agregar Asiento</button>
                <hr class="my-1">
                <button onclick="cerrarMes()" class="btn btn-success fw-bold">Cerrar Mes</button>
                <button onclick="window.print()" class="btn btn-secondary btn-sm">Imprimir Reporte</button>
            </div>
        </div>
    </div>

    <hr>

    <div id="reporte-exportable">
        <h3 class="mb-3">Reporte Contable Detallado</h3>
        
        <div class="row">
            <div class="col-md-7">
                <h4>Libro Diario</h4>
                <table class="table table-bordered bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Cuenta</th>
                            <th>Debe</th>
                            <th>Haber</th>
                            <th class="no-print">Acci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="tabla"></tbody>
                </table>
            </div>
            <div class="col-md-5">
                <h4>Resumen Financiero</h4>
                <div id="balance" class="alert alert-info py-2">Pendiente...</div>
                <div id="resultado" class="alert alert-warning py-2">Pendiente...</div>
            </div>
        </div>

        <h4 class="mt-4">Balance de Comprobaci贸n</h4>
        <div id="balanceComprobacion" class="bg-white"></div>

        <h4 class="mt-4">Libro Mayor</h4>
        <div id="mayor" class="d-flex flex-wrap gap-2"></div>

        <h4 class="mt-5 text-primary">Historial de Cierres Mensuales</h4>
        <table class="table table-bordered bg-white">
            <thead class="table-dark">
                <tr>
                    <th>Mes</th>
                    <th>Activos</th>
                    <th>Pasivos</th>
                    <th>Patrimonio</th>
                    <th>Ingresos</th>
                    <th>Gastos/Costos</th>
                    <th>Utilidad</th>
                </tr>
            </thead>
            <tbody id="libroMensual"></tbody>
        </table>
    </div>
</div>

<script>
let movimientos = [];
let cierresMensuales = [];
let mesesCerrados = [];

// --- FUNCIN GUARDAR EN WORD ---
function guardarWord() {
    const contenido = document.getElementById('reporte-exportable').innerHTML;
    
    // Crear el encabezado necesario para que Word reconozca el HTML y los estilos
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
            "xmlns:w='urn:schemas-microsoft-com:office:word' " +
            "xmlns='http://www.w3.org/TR/REC-html40'>" +
            "<head><meta charset='utf-8'><title>Export Word</title><style>" +
            "table { border-collapse: collapse; width: 100%; } " +
            "th, td { border: 1px solid black; padding: 8px; text-align: left; } " +
            ".table-dark { background-color: #343a40; color: white; } " +
            ".alert { padding: 10px; border: 1px solid #bee5eb; background: #d1ecf1; margin-bottom: 10px; }" +
            "</style></head><body>";
    const footer = "</body></html>";
    
    const sourceHTML = header + contenido + footer;
    
    // Crear el enlace de descarga
    const blob = new Blob(['\ufeff', sourceHTML], {
        type: 'application/msword'
    });
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "Sistema_Contable_Reporte.doc";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- FUNCIN RESETEAR ---
function resetearPrograma() {
    if (confirm("驴Seguro que quieres borrar todo? Se eliminar谩n los asientos y el historial.")) {
        movimientos = [];
        cierresMensuales = [];
        mesesCerrados = [];
        renderizar();
        renderizarLibroMensual();
        alert("Programa reiniciado.");
    }
}

function calcularIVA() {
    let d = Number(document.getElementById("debe").value) || 0;
    let h = Number(document.getElementById("haber").value) || 0;
    if (d > 0) {
        document.getElementById("cuenta").value = "IVA Cr茅dito Fiscal";
        document.getElementById("debe").value = Math.round(d * 0.19);
        document.getElementById("clasificacion").value = "Activo";
    } else if (h > 0) {
        document.getElementById("cuenta").value = "IVA D茅bito Fiscal";
        document.getElementById("haber").value = Math.round(h * 0.19);
        document.getElementById("clasificacion").value = "Pasivo";
    }
}

function agregar() {
    let m = {
        f: document.getElementById("fecha").value || new Date().toISOString().split('T')[0],
        c: document.getElementById("cuenta").value,
        g: document.getElementById("glosa").value,
        d: Number(document.getElementById("debe").value) || 0,
        h: Number(document.getElementById("haber").value) || 0,
        cl: document.getElementById("clasificacion").value
    };
    if (!m.c) return alert("Ingresa una cuenta");
    movimientos.push(m);
    renderizar();
}

function eliminar(i) {
    movimientos.splice(i, 1);
    renderizar();
}

function renderizar() {
    let t = document.getElementById("tabla");
    t.innerHTML = "";
    let tot = { Activo: 0, Pasivo: 0, Patrimonio: 0, Costo: 0, Gasto: 0, Ingreso: 0 };
    let mayor = {};

    movimientos.forEach((m, i) => {
        t.innerHTML += `<tr><td>${m.f}</td><td>${m.c}</td><td>${m.d}</td><td>${m.h}</td>
            <td class="no-print"><button onclick="eliminar(${i})" class="btn btn-sm btn-danger">x</button></td></tr>`;
        tot[m.cl] += (m.d - m.h);
        if (!mayor[m.c]) mayor[m.c] = { d: 0, h: 0 };
        mayor[m.c].d += m.d; mayor[m.c].h += m.h;
    });

    let utilidad = Math.abs(tot.Ingreso) - (Math.abs(tot.Gasto) + Math.abs(tot.Costo));
    document.getElementById("balance").innerHTML = `<b>Situaci贸n:</b> Activo: $${tot.Activo} | Pasivo: $${Math.abs(tot.Pasivo)}`;
    document.getElementById("resultado").innerHTML = `<b>Resultado:</b> Utilidad: $${utilidad}`;

    renderizarMayor(mayor);
    renderizarComprobacion(mayor);
}

function renderizarMayor(mayor) {
    let html = "";
    for (let c in mayor) {
        html += `<div class="border p-2 bg-white" style="min-width:120px; text-align:center;">
            <div class="fw-bold border-bottom">${c}</div>
            <div class="d-flex"><div class="px-2 border-end text-success">${mayor[c].d}</div>
            <div class="px-2 text-danger">${mayor[c].h}</div></div></div>`;
    }
    document.getElementById("mayor").innerHTML = html;
}

function renderizarComprobacion(mayor) {
    let h = "<table class='table table-sm table-bordered'><tr><th>Cuenta</th><th>Debe</th><th>Haber</th></tr>";
    let td = 0, th = 0;
    for (let c in mayor) {
        h += `<tr><td>${c}</td><td>${mayor[c].d}</td><td>${mayor[c].h}</td></tr>`;
        td += mayor[c].d; th += mayor[c].h;
    }
    h += `<tr class="table-dark"><td>TOTAL</td><td>${td}</td><td>${th}</td></tr></table>`;
    document.getElementById("balanceComprobacion").innerHTML = h;
}

function cerrarMes() {
    if (movimientos.length === 0) return;
    let tot = { Activo: 0, Pasivo: 0, Patrimonio: 0, Costo: 0, Gasto: 0, Ingreso: 0 };
    movimientos.forEach(m => { tot[m.cl] += (m.d - m.h); });

    let ing = Math.abs(tot.Ingreso);
    let egr = Math.abs(tot.Gasto) + Math.abs(tot.Costo);

    cierresMensuales.push({
        mes: new Date().toLocaleString('default', { month: 'long' }),
        activo: tot.Activo,
        pasivo: Math.abs(tot.Pasivo),
        patrimonio: Math.abs(tot.Patrimonio),
        ingresos: ing,
        gastos: egr,
        utilidad: ing - egr
    });

    movimientos = [];
    renderizar();
    renderizarLibroMensual();
}

function renderizarLibroMensual() {
    let t = document.getElementById("libroMensual");
    t.innerHTML = "";
    cierresMensuales.forEach(c => {
        t.innerHTML += `<tr><td>${c.mes}</td><td>${c.activo}</td><td>${c.pasivo}</td>
            <td>${c.patrimonio}</td><td>${c.ingresos}</td><td>${c.gastos}</td><td class="fw-bold text-primary">${c.utilidad}</td></tr>`;
    });
}
</script>

</body>
</html>