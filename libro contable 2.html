<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema Contable Completo</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{ background:#eef2f7; }
.header{
    background:#1f3c88;
    color:white;
    padding:20px;
    text-align:center;
}
.card-box{
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<div class="header">
<h2>Sistema Contable Profesional Completo</h2>
</div>

<div class="container mt-4">
<div class="row">

<!-- FORMULARIO -->
<div class="col-md-4">
<div class="card card-box p-3">

<h5>Registrar Movimiento</h5>

<form id="formContable">
<input type="date" id="fecha" class="form-control mb-2" required>
<input type="text" id="concepto" class="form-control mb-2" placeholder="Concepto" required>
<input type="number" id="monto" class="form-control mb-2" placeholder="Monto" required>

<select id="tipo" class="form-select mb-2" required>
<option value="">Debe / Haber</option>
<option value="Debe">Debe</option>
<option value="Haber">Haber</option>
</select>

<select id="clasificacion" class="form-select mb-2" required>
<option value="">ClasificaciÃ³n</option>
<option value="Activo">Activo</option>
<option value="Pasivo">Pasivo</option>
<option value="Patrimonio">Patrimonio</option>
</select>

<select id="banco" class="form-select mb-2">
<option value="">Banco</option>
<option>Banco de Chile</option>
<option>Banco Estado</option>
<option>Banco Santander</option>
<option>Banco BCI</option>
<option>Banco ItaÃº</option>
<option>Banco Security</option>
<option>Scotiabank</option>
<option>Banco Falabella</option>
<option>Banco Ripley</option>
</select>

<select id="cuentaTipo" class="form-select mb-2">
<option value="">Tipo Cuenta</option>
<option>Cuenta Corriente</option>
<option>Cuenta Vista</option>
<option>Cuenta RUT</option>
<option>Cuenta Ahorro</option>
<option>Cuenta Empresa</option>
</select>

<button class="btn btn-success w-100">Registrar</button>
</form>

<hr>

<button onclick="exportarExcel()" class="btn btn-primary w-100 mb-2">Exportar Excel</button>
<button onclick="window.print()" class="btn btn-secondary w-100">Imprimir</button>

</div>
</div>

<div class="col-md-8">

<!-- LIBRO DIARIO -->
<div class="card card-box p-3">
<h5>ðŸ“˜ Libro Diario</h5>
<table class="table table-bordered text-center">
<thead class="table-dark">
<tr>
<th>Fecha</th>
<th>Concepto</th>
<th>ClasificaciÃ³n</th>
<th>Debe</th>
<th>Haber</th>
<th>Eliminar</th>
</tr>
</thead>
<tbody id="tablaDiario"></tbody>
</table>
</div>

<!-- LIBRO MAYOR -->
<div class="card card-box p-3 mt-4">
<h5>ðŸ“— Libro Mayor</h5>
<div id="libroMayor"></div>
</div>

<!-- BALANCE -->
<div class="card card-box p-3 mt-4">
<h5>ðŸ“Š Balance General</h5>
<p>Activo: $<span id="activo">0</span></p>
<p>Pasivo: $<span id="pasivo">0</span></p>
<p>Patrimonio: $<span id="patrimonio">0</span></p>
<hr>
<p id="ecuacion"></p>
</div>

<!-- GRAFICO -->
<div class="card card-box p-3 mt-4">
<h5>GrÃ¡fico Debe vs Haber</h5>
<canvas id="grafico"></canvas>
</div>

</div>
</div>
</div>

<script>
let movimientos = JSON.parse(localStorage.getItem("movimientosFull")) || [];
let chart;

document.getElementById("formContable").addEventListener("submit", function(e){
e.preventDefault();

movimientos.push({
fecha: fecha.value,
concepto: concepto.value,
monto: parseFloat(monto.value),
tipo: tipo.value,
clasificacion: clasificacion.value
});

localStorage.setItem("movimientosFull", JSON.stringify(movimientos));
this.reset();
mostrar();
});

function mostrar(){

let diario = document.getElementById("tablaDiario");
let mayor = document.getElementById("libroMayor");

diario.innerHTML="";
mayor.innerHTML="";

let totalDebe=0, totalHaber=0;
let cuentas = {Activo:[], Pasivo:[], Patrimonio:[]};
let saldo = {Activo:0, Pasivo:0, Patrimonio:0};

movimientos.forEach((mov,index)=>{

let debe="", haber="";

if(mov.tipo==="Debe"){
debe=mov.monto;
totalDebe+=mov.monto;
}else{
haber=mov.monto;
totalHaber+=mov.monto;
}

cuentas[mov.clasificacion].push(mov);

if(mov.clasificacion==="Activo"){
saldo.Activo += mov.tipo==="Debe" ? mov.monto : -mov.monto;
}
if(mov.clasificacion==="Pasivo"){
saldo.Pasivo += mov.tipo==="Haber" ? mov.monto : -mov.monto;
}
if(mov.clasificacion==="Patrimonio"){
saldo.Patrimonio += mov.tipo==="Haber" ? mov.monto : -mov.monto;
}

diario.innerHTML+=`
<tr>
<td>${mov.fecha}</td>
<td>${mov.concepto}</td>
<td>${mov.clasificacion}</td>
<td class="text-success">${debe?debe.toLocaleString():""}</td>
<td class="text-danger">${haber?haber.toLocaleString():""}</td>
<td><button onclick="eliminar(${index})" class="btn btn-sm btn-danger">X</button></td>
</tr>`;
});

for(let cuenta in cuentas){
mayor.innerHTML+=`<h6>${cuenta}</h6>`;
cuentas[cuenta].forEach(m=>{
mayor.innerHTML+=`
<p>${m.fecha} - ${m.concepto} | ${m.tipo}: $${m.monto.toLocaleString()}</p>`;
});
mayor.innerHTML+=`<strong>Saldo ${cuenta}: $${saldo[cuenta].toLocaleString()}</strong><hr>`;
}

document.getElementById("activo").textContent=saldo.Activo.toLocaleString();
document.getElementById("pasivo").textContent=saldo.Pasivo.toLocaleString();
document.getElementById("patrimonio").textContent=saldo.Patrimonio.toLocaleString();

document.getElementById("ecuacion").textContent=
"Activo ("+saldo.Activo.toLocaleString()+") = Pasivo ("+
saldo.Pasivo.toLocaleString()+") + Patrimonio ("+
saldo.Patrimonio.toLocaleString()+")";

actualizarGrafico(totalDebe,totalHaber);
}

function eliminar(index){
movimientos.splice(index,1);
localStorage.setItem("movimientosFull", JSON.stringify(movimientos));
mostrar();
}

function exportarExcel(){
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.json_to_sheet(movimientos);
XLSX.utils.book_append_sheet(wb,ws,"Libro Diario");
XLSX.writeFile(wb,"Libro_Diario.xlsx");
}

function actualizarGrafico(debe,haber){
let ctx=document.getElementById("grafico");
if(chart){chart.destroy();}
chart=new Chart(ctx,{
type:"bar",
data:{
labels:["Debe","Haber"],
datasets:[{
label:"Totales",
data:[debe,haber],
backgroundColor:["green","red"]
}]
}
});
}

mostrar();
</script>

</body>
</html>