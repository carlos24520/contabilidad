<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema Contable Pro Elite - 8 Columnas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --sii-blue: #003366; }
        .f-box { border: 2px solid #000; padding: 20px; background-color: #fff; margin-bottom: 20px; }
        
        /* Estilo T-Accounts */
        .t-account { border: 1px solid #ccc; min-width: 180px; background: white; flex-grow: 1; }
        .t-header { border-bottom: 2px solid #000; text-align: center; font-weight: bold; padding: 5px; background: #eee; }
        .t-body { display: flex; min-height: 50px; }
        .t-side { width: 50%; padding: 5px; font-size: 0.85rem; }
        .t-left { border-right: 2px solid #000; text-align: right; color: #198754; }
        .t-right { text-align: left; color: #dc3545; }
        .t-footer { border-top: 2px solid #000; font-weight: bold; display: flex; font-size: 0.8rem; background: #f8f9fa; }

        /* Ajustes para tabla de 8 columnas */
        .table-8c { font-size: 0.8rem; vertical-align: middle; }
        .table-8c th { background-color: var(--sii-blue) !important; color: white !important; text-align: center; }
        .bg-subtotal { background-color: #f1f3f5; font-weight: bold; }
        .bg-utilidad { background-color: #e8f5e9; font-weight: bold; color: #2e7d32; }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; padding: 0; }
            .container { max-width: 100% !important; width: 100% !important; }
            .table-8c { font-size: 0.7rem; }
        }
    </style>
</head>

<body class="bg-light">

<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2 class="mb-0">Contabilidad Pro Elite <span class="badge bg-dark">8 Columnas</span></h2>
            <small>Libro Diario, Mayor T, Balance de 8 Columnas, F29 y F22</small>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-dark">üñ®Ô∏è Imprimir Reporte</button>
            <button onclick="guardarWord()" class="btn btn-primary">üìÑ Exportar Word</button>
            <button onclick="resetearPrograma()" class="btn btn-danger btn-sm">‚ö†Ô∏è Resetear Sistema</button>
        </div>
    </div>

    <div class="card p-3 mb-4 shadow-sm no-print border-0">
        <div class="row g-2">
            <div class="col-md-9">
                <div class="row mb-2">
                    <div class="col-md-2"><label class="small fw-bold">Fecha</label><input type="date" id="fecha" class="form-control form-control-sm"></div>
                    <div class="col-md-3"><label class="small fw-bold">Cuenta</label><input type="text" id="cuenta" class="form-control form-control-sm" placeholder="Ej: Mercader√≠as"></div>
                    <div class="col-md-4"><label class="small fw-bold">Glosa</label><input type="text" id="glosa" class="form-control form-control-sm" placeholder="Descripci√≥n del asiento"></div>
                    <div class="col-md-3">
                        <label class="small fw-bold">Clasificaci√≥n (Para Balance)</label>
                        <select id="clasificacion" class="form-select form-select-sm">
                            <option value="Activo">Activo</option>
                            <option value="Pasivo">Pasivo / Patrimonio</option>
                            <option value="Gasto">P√©rdida (Gasto/Costo)</option>
                            <option value="Ingreso">Ganancia (Ingreso)</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3"><input type="number" id="debe" class="form-control" placeholder="Debe $"></div>
                    <div class="col-md-3"><input type="number" id="haber" class="form-control" placeholder="Haber $"></div>
                    <div class="col-md-6"><button onclick="calcularIVA()" class="btn btn-info w-100 text-white fw-bold">Calculadora IVA 19%</button></div>
                </div>
            </div>
            <div class="col-md-3 d-grid gap-2">
                <button onclick="agregar()" class="btn btn-primary btn-lg">Agregar Asiento</button>
                <button onclick="cerrarMes()" class="btn btn-success fw-bold">Cerrar Mes Actual</button>
            </div>
        </div>
    </div>

    <div id="reporte-exportable">
        <div class="row">
            <div class="col-md-6">
                <h5 class="fw-bold">1. Libro Diario</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered bg-white">
                        <thead class="table-dark">
                            <tr><th>Fecha</th><th>Cuenta</th><th>Debe</th><th>Haber</th><th class="no-print"></th></tr>
                        </thead>
                        <tbody id="tablaDiario"></tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-6">
                <h5 class="fw-bold">2. Libro Mayor (Esquemas T)</h5>
                <div id="mayorT" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h5 class="fw-bold">3. Balance de Comprobaci√≥n y Saldos (8 Columnas)</h5>
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered bg-white table-8c">
                        <thead>
                            <tr>
                                <th rowspan="2">Cuentas</th>
                                <th colspan="2">Sumas</th>
                                <th colspan="2">Saldos</th>
                                <th colspan="2">Inventario</th>
                                <th colspan="2">Resultado</th>
                            </tr>
                            <tr>
                                <th>Debe</th><th>Haber</th><th>Deudor</th><th>Acreedor</th>
                                <th>Activo</th><th>Pasivo</th><th>P√©rdida</th><th>Ganancia</th>
                            </tr>
                        </thead>
                        <tbody id="body8c"></tbody>
                        <tfoot id="foot8c"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="f-box" id="f29-area">
                    <h6 class="fw-bold text-primary">SIMULADOR F29 (MENSUAL)</h6>
                    <div id="f29-content">Calcule para ver detalles...</div>
                    <button onclick="generarF29()" class="btn btn-sm btn-warning mt-2 no-print">Generar F29</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="f-box" id="f22-area">
                    <h6 class="fw-bold text-danger">SIMULADOR F22 (ANUAL)</h6>
                    <div id="f22-content">Cierre meses para ver acumulado...</div>
                    <button onclick="generarF22()" class="btn btn-sm btn-dark mt-2 no-print">Generar F22</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let movimientos = [];
let cierresMensuales = [];

function calcularIVA() {
    let d = Number(document.getElementById("debe").value) || 0;
    let h = Number(document.getElementById("haber").value) || 0;
    if (d > 0) {
        document.getElementById("cuenta").value = "IVA Cr√©dito Fiscal";
        document.getElementById("debe").value = Math.round(d * 0.19);
        document.getElementById("clasificacion").value = "Activo";
    } else if (h > 0) {
        document.getElementById("cuenta").value = "IVA D√©bito Fiscal";
        document.getElementById("haber").value = Math.round(h * 0.19);
        document.getElementById("clasificacion").value = "Pasivo";
    }
}

function agregar() {
    let m = {
        f: document.getElementById("fecha").value || new Date().toISOString().split('T')[0],
        c: document.getElementById("cuenta").value,
        g: document.getElementById("glosa").value,
        d: Number(document.getElementById("debe").value) || 0,
        h: Number(document.getElementById("haber").value) || 0,
        cl: document.getElementById("clasificacion").value
    };
    if (!m.c) return alert("Ingrese nombre de cuenta");
    movimientos.push(m);
    actualizarVistas();
    document.getElementById("cuenta").value = "";
    document.getElementById("debe").value = "";
    document.getElementById("haber").value = "";
}

function eliminar(i) { movimientos.splice(i, 1); actualizarVistas(); }

function actualizarVistas() {
    renderDiario();
    let mayor = procesarDatos();
    renderMayorT(mayor);
    render8Columnas(mayor);
}

function renderDiario() {
    let t = document.getElementById("tablaDiario");
    t.innerHTML = "";
    movimientos.forEach((m, i) => {
        t.innerHTML += `<tr><td>${m.f}</td><td>${m.c}</td><td>${m.d || '-'}</td><td>${m.h || '-'}</td>
        <td class="no-print"><button onclick="eliminar(${i})" class="btn btn-sm btn-link text-danger p-0">x</button></td></tr>`;
    });
}

function procesarDatos() {
    let mayor = {};
    movimientos.forEach(m => {
        if (!mayor[m.c]) mayor[m.c] = { debe: [], haber: [], totalD: 0, totalH: 0, tipo: m.cl };
        if (m.d > 0) { mayor[m.c].debe.push(m.d); mayor[m.c].totalD += m.d; }
        if (m.h > 0) { mayor[m.c].haber.push(m.h); mayor[m.c].totalH += m.h; }
    });
    return mayor;
}

function renderMayorT(mayor) {
    let cont = document.getElementById("mayorT");
    cont.innerHTML = "";
    for (let c in mayor) {
        cont.innerHTML += `<div class="t-account shadow-sm">
            <div class="t-header">${c}</div>
            <div class="t-body">
                <div class="t-side t-left">${mayor[c].debe.join('<br>')}</div>
                <div class="t-side t-right">${mayor[c].haber.join('<br>')}</div>
            </div>
            <div class="t-footer">
                <div class="t-side t-left">${mayor[c].totalD}</div>
                <div class="t-side t-right">${mayor[c].totalH}</div>
            </div>
        </div>`;
    }
}

function render8Columnas(mayor) {
    let body = document.getElementById("body8c");
    let foot = document.getElementById("foot8c");
    body.innerHTML = "";
    
    let sum = { sd:0, sh:0, sder:0, sacr:0, act:0, pas:0, per:0, gan:0 };

    for (let c in mayor) {
        let m = mayor[c];
        let deudor = Math.max(0, m.totalD - m.totalH);
        let acreedor = Math.max(0, m.totalH - m.totalD);
        
        let col = { act:0, pas:0, per:0, gan:0 };
        if (m.tipo === "Activo") col.act = deudor;
        if (m.tipo === "Pasivo") col.pas = acreedor;
        if (m.tipo === "Gasto") col.per = deudor;
        if (m.tipo === "Ingreso") col.gan = acreedor;

        body.innerHTML += `<tr>
            <td>${c}</td><td>${m.totalD}</td><td>${m.totalH}</td>
            <td>${deudor || ''}</td><td>${acreedor || ''}</td>
            <td>${col.act || ''}</td><td>${col.pas || ''}</td>
            <td>${col.per || ''}</td><td>${col.gan || ''}</td>
        </tr>`;

        sum.sd += m.totalD; sum.sh += m.totalH; sum.sder += deudor; sum.sacr += acreedor;
        sum.act += col.act; sum.pas += col.pas; sum.per += col.per; sum.gan += col.gan;
    }

    let utilInv = sum.act - sum.pas;
    let utilRes = sum.gan - sum.per;

    foot.innerHTML = `
        <tr class="bg-subtotal">
            <td>SUBTOTALES</td><td>${sum.sd}</td><td>${sum.sh}</td><td>${sum.sder}</td><td>${sum.sacr}</td>
            <td>${sum.act}</td><td>${sum.pas}</td><td>${sum.per}</td><td>${sum.gan}</td>
        </tr>
        <tr class="bg-utilidad">
            <td colspan="5">RESULTADO DEL EJERCICIO</td>
            <td>${utilInv < 0 ? Math.abs(utilInv) : ''}</td><td>${utilInv > 0 ? utilInv : ''}</td>
            <td>${utilRes > 0 ? utilRes : ''}</td><td>${utilRes < 0 ? Math.abs(utilRes) : ''}</td>
        </tr>
        <tr class="table-dark">
            <td colspan="5">TOTALES IGUALES</td>
            <td colspan="2" class="text-center">${Math.max(sum.act, sum.pas + utilInv)}</td>
            <td colspan="2" class="text-center">${Math.max(sum.per + utilRes, sum.gan)}</td>
        </tr>`;
}

function generarF29() {
    let deb = 0, cre = 0, ing = 0;
    movimientos.forEach(m => {
        if (m.c.toLowerCase().includes("iva d√©bito")) deb += m.h;
        if (m.c.toLowerCase().includes("iva cr√©dito")) cre += m.d;
        if (m.cl === "Ingreso") ing += (m.h - m.d);
    });
    let ppm = Math.round(ing * 0.01);
    document.getElementById("f29-content").innerHTML = `
        IVA D√©bito: $${deb} | IVA Cr√©dito: $${cre}<br>
        PPM (1%): $${ppm} | <b>Total Pago: $${Math.max(0, deb-cre)+ppm}</b>`;
}

function generarF22() {
    let ing = cierresMensuales.reduce((a,b) => a + b.i, 0);
    let gas = cierresMensuales.reduce((a,b) => a + b.g, 0);
    document.getElementById("f22-content").innerHTML = `
        Ingresos Anuales: $${ing} | Gastos Anuales: $${gas}<br>
        Base Imponible: $${ing-gas} | <b>Impuesto (10%): $${Math.max(0, Math.round((ing-gas)*0.1))}</b>`;
}

function cerrarMes() {
    if (movimientos.length === 0) return;
    let ing = 0, gas = 0;
    movimientos.forEach(m => {
        if(m.cl === 'Ingreso') ing += (m.h - m.d);
        if(m.cl === 'Gasto') gas += (m.d - m.h);
    });
    cierresMensuales.push({ i: ing, g: gas });
    movimientos = []; actualizarVistas();
    alert("Mes cerrado y guardado en historial.");
}

function guardarWord() {
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border:1px solid black; border-collapse:collapse; width:100%; font-size:10px;} th,td{border:1px solid black; padding:3px;}</style></head><body>";
    const blob = new Blob(['\ufeff', header + document.getElementById('reporte-exportable').innerHTML + "</body></html>"], { type: 'application/msword' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Contabilidad_8C_${new Date().toLocaleDateString()}.doc`;
    link.click();
}

function resetearPrograma() {
    if (confirm("¬øBorrar toda la base de datos contable?")) {
        movimientos = []; cierresMensuales = []; actualizarVistas();
    }
}
</script>

</body>
</html>