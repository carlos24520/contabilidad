<!DOCTYPE html>
<html>
<head>
<title>Sistema Contable Pro Integral</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">
<div class="container mt-5">

<h2 class="mb-4">Sistema Contable Profesional</h2>

<!-- INGRESO TRANSACCIONES -->
<div class="card p-3 mb-4">
<div class="row">

<div class="col-md-2">
<input type="date" id="fecha" class="form-control">
</div>

<div class="col-md-3">
<input type="text" id="concepto" class="form-control" placeholder="Concepto">
</div>

<div class="col-md-2">
<input type="number" id="monto" class="form-control" placeholder="Monto">
</div>

<div class="col-md-2">
<select id="tipo" class="form-control">
<option>Ingreso</option>
<option>Gasto</option>
<option>Costo</option>
</select>
</div>

<div class="col-md-3">
<button onclick="agregarTransaccion()" class="btn btn-success w-100">Agregar</button>
</div>

</div>
</div>

<!-- LIBRO DIARIO -->
<h4>Libro Diario</h4>
<table class="table table-bordered">
<thead>
<tr>
<th>Fecha</th>
<th>Concepto</th>
<th>Monto</th>
<th>Tipo</th>
<th>Acción</th>
</tr>
</thead>
<tbody id="tablaTransacciones"></tbody>
</table>

<!-- BARRA DE BOTONES -->
<div class="card p-3 mb-4">
<div class="d-flex flex-wrap gap-2 align-items-center">

<button onclick="cerrarMes()" class="btn btn-primary">Cerrar Mes</button>

<input type="number" id="filtroAnio" class="form-control" placeholder="Año" style="max-width:120px;">

<button onclick="filtrarPorAnio()" class="btn btn-info">Filtrar</button>

<button onclick="exportarLibroMensualExcel()" class="btn btn-success">Exportar Excel</button>

<button onclick="calcularIVA()" class="btn btn-warning">Calcular IVA</button>

<button onclick="guardarWord()" class="btn btn-secondary">Guardar Word</button>

<button onclick="imprimir()" class="btn btn-dark">Imprimir</button>

</div>
</div>

<!-- LIBRO MENSUAL -->
<h4>Libro de Cierre Mensual</h4>
<canvas id="graficoCierres" class="mb-4"></canvas>

<table class="table table-striped">
<thead>
<tr>
<th>Mes</th>
<th>Ingresos</th>
<th>Gastos</th>
<th>Costos</th>
<th>Utilidad</th>
<th>Acción</th>
</tr>
</thead>
<tbody id="libroMensual"></tbody>
<tfoot>
<tr class="table-dark">
<th>Totales</th>
<th id="acumIngresos">0</th>
<th id="acumGastos">0</th>
<th id="acumCostos">0</th>
<th id="acumUtilidad">0</th>
<th></th>
</tr>
</tfoot>
</table>

<hr>

<h4>Libro Mayor (Formato T)</h4>
<div id="libroMayor"></div>

<hr>

<h4>Estado de Resultados</h4>
<div id="estadoResultados"></div>

<hr>

<h4>Balance General</h4>
<div id="balanceGeneral"></div>

<hr>

<h4>Balance de Comprobación</h4>
<div id="balanceComprobacion"></div>

<hr>

<h4>Gráfico Financiero</h4>
<canvas id="graficoFinanciero" height="100"></canvas>

<div id="resultadoIVA" class="alert alert-info mt-4" style="display:none;"></div>

</div>

<script>

let transacciones=[];
let cierresMensuales=[];
let mesesCerrados=[];
let grafico=null;
let graficoFinanciero=null;
let patrimonio=0;

/* AGREGAR TRANSACCIÓN */
function agregarTransaccion(){
let fecha=document.getElementById("fecha").value;
let concepto=document.getElementById("concepto").value;
let monto=parseFloat(document.getElementById("monto").value);
let tipo=document.getElementById("tipo").value;

if(!fecha||!concepto||!monto){alert("Complete todos los campos");return;}

let mesClave=fecha.substring(0,7);
if(mesesCerrados.includes(mesClave)){alert("Mes cerrado.");return;}

transacciones.push({fecha,concepto,monto,tipo});
renderizarTabla();
}

/* LIBRO DIARIO */
function renderizarTabla(){
let tabla=document.getElementById("tablaTransacciones");
tabla.innerHTML="";
transacciones.forEach((t,i)=>{
tabla.innerHTML+=`
<tr>
<td>${t.fecha}</td>
<td>${t.concepto}</td>
<td>${t.monto}</td>
<td>${t.tipo}</td>
<td><button onclick="eliminarTransaccion(${i})" class="btn btn-danger btn-sm">Eliminar</button></td>
</tr>`;
});
}

function eliminarTransaccion(i){
transacciones.splice(i,1);
renderizarTabla();
}

/* CIERRE MENSUAL */
function cerrarMes(){

if(transacciones.length===0){alert("No hay transacciones");return;}

let ingresos=0,gastos=0,costos=0;
transacciones.forEach(t=>{
if(t.tipo==="Ingreso") ingresos+=t.monto;
if(t.tipo==="Gasto") gastos+=t.monto;
if(t.tipo==="Costo") costos+=t.monto;
});

let utilidad=ingresos-gastos-costos;
let fecha=new Date(transacciones[0].fecha);
let mesClave=transacciones[0].fecha.substring(0,7);
let nombreMes=(fecha.getMonth()+1)+"-"+fecha.getFullYear();

cierresMensuales.push({mes:nombreMes,mesClave,ingresos,gastos,costos,utilidad});
patrimonio+=utilidad;
mesesCerrados.push(mesClave);

transacciones=[];
renderizarTabla();
renderizarTodo();
}

/* RENDER GENERAL */
function renderizarTodo(){
renderizarLibroMensual();
renderizarLibroMayor();
renderizarEstadoResultados();
renderizarBalanceGeneral();
renderizarBalanceComprobacion();
renderizarGraficoFinanciero();
}

/* LIBRO MENSUAL */
function renderizarLibroMensual(lista=cierresMensuales){
let tabla=document.getElementById("libroMensual");
tabla.innerHTML="";
let totalIng=0,totalGas=0,totalCos=0,totalUti=0;
let labels=[],data=[];
lista.forEach((c,i)=>{
tabla.innerHTML+=`
<tr>
<td>${c.mes}</td>
<td>${c.ingresos}</td>
<td>${c.gastos}</td>
<td>${c.costos}</td>
<td>${c.utilidad}</td>
<td><button onclick="eliminarCierre(${i})" class="btn btn-danger btn-sm">Eliminar</button></td>
</tr>`;
totalIng+=c.ingresos;
totalGas+=c.gastos;
totalCos+=c.costos;
totalUti+=c.utilidad;
labels.push(c.mes);
data.push(c.utilidad);
});
document.getElementById("acumIngresos").innerText=totalIng;
document.getElementById("acumGastos").innerText=totalGas;
document.getElementById("acumCostos").innerText=totalCos;
document.getElementById("acumUtilidad").innerText=totalUti;
actualizarGrafico(labels,data);
}

/* RESTO DE FUNCIONES CONTABLES */
function renderizarLibroMayor(){
let ing=0,gas=0,cos=0;
cierresMensuales.forEach(c=>{ing+=c.ingresos;gas+=c.gastos;cos+=c.costos;});
document.getElementById("libroMayor").innerHTML=`
<div class="row">
<div class="col-md-4"><h6>Ingresos</h6><table class="table table-bordered"><tr><th>Debe</th><th>Haber</th></tr><tr><td></td><td>${ing}</td></tr></table></div>
<div class="col-md-4"><h6>Gastos</h6><table class="table table-bordered"><tr><th>Debe</th><th>Haber</th></tr><tr><td>${gas}</td><td></td></tr></table></div>
<div class="col-md-4"><h6>Costos</h6><table class="table table-bordered"><tr><th>Debe</th><th>Haber</th></tr><tr><td>${cos}</td><td></td></tr></table></div>
</div>`;
}

function renderizarEstadoResultados(){
let ing=0,gas=0,cos=0;
cierresMensuales.forEach(c=>{ing+=c.ingresos;gas+=c.gastos;cos+=c.costos;});
let util=ing-gas-cos;
document.getElementById("estadoResultados").innerHTML=`
<table class="table table-bordered">
<tr><td>Ingresos</td><td>${ing}</td></tr>
<tr><td>Gastos</td><td>${gas}</td></tr>
<tr><td>Costos</td><td>${cos}</td></tr>
<tr class="table-success"><td><b>Utilidad</b></td><td><b>${util}</b></td></tr>
</table>`;
}

function renderizarBalanceGeneral(){
document.getElementById("balanceGeneral").innerHTML=`
<div class="row">
<div class="col-md-6"><h6>ACTIVOS</h6>Caja/Banco: ${patrimonio}</div>
<div class="col-md-6"><h6>PATRIMONIO</h6>${patrimonio}</div>
</div>`;
}

function renderizarBalanceComprobacion(){
let ing=0,gas=0,cos=0;
cierresMensuales.forEach(c=>{ing+=c.ingresos;gas+=c.gastos;cos+=c.costos;});
document.getElementById("balanceComprobacion").innerHTML=`
<table class="table table-bordered">
<tr><th>Cuenta</th><th>Debe</th><th>Haber</th></tr>
<tr><td>Gastos</td><td>${gas}</td><td></td></tr>
<tr><td>Costos</td><td>${cos}</td><td></td></tr>
<tr><td>Ingresos</td><td></td><td>${ing}</td></tr>
</table>`;
}

function renderizarGraficoFinanciero(){
let ing=0,gas=0,cos=0;
cierresMensuales.forEach(c=>{ing+=c.ingresos;gas+=c.gastos;cos+=c.costos;});
let ctx=document.getElementById("graficoFinanciero");
if(graficoFinanciero) graficoFinanciero.destroy();
graficoFinanciero=new Chart(ctx,{type:"pie",data:{labels:["Ingresos","Gastos","Costos"],datasets:[{data:[ing,gas,cos]}]}});
}

function actualizarGrafico(labels,data){
let ctx=document.getElementById("graficoCierres");
if(grafico) grafico.destroy();
grafico=new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{label:"Utilidad",data:data}]}});}

function calcularIVA(){
let ing=0,gas=0,cos=0;
transacciones.forEach(t=>{if(t.tipo==="Ingreso")ing+=t.monto;if(t.tipo==="Gasto")gas+=t.monto;if(t.tipo==="Costo")cos+=t.monto;});
let deb=ing*0.19,cred=(gas+cos)*0.19,fin=deb-cred;
document.getElementById("resultadoIVA").style.display="block";
document.getElementById("resultadoIVA").innerHTML=`IVA Débito: ${deb.toFixed(0)}<br>IVA Crédito: ${cred.toFixed(0)}<br><b>${fin>=0?"IVA a Pagar":"Remanente"}: ${Math.abs(fin).toFixed(0)}</b>`;
}

function exportarLibroMensualExcel(){
let tabla=document.getElementById("libroMensual").outerHTML;
let blob=new Blob([tabla],{type:"application/vnd.ms-excel"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="Libro_Mensual.xls";
link.click();
}

function guardarWord(){
let contenido=document.body.innerHTML;
let blob=new Blob([contenido],{type:"application/msword"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="Reporte_Contable.doc";
link.click();
}

function imprimir(){window.print();}

</script>
</body>
</html>